name: Codecov

on:
    push:
        branches: [master]
        paths:
            - ".github/workflows/coverage.yml"
            - "api/*.py"
            - "tests/*.py"
            - "sonar-project.properties"
            - ".pre-commit-config.yaml"
    pull_request:
        branches: [master]

permissions:
    contents: read

jobs:
    pre-commit:
        if: |
            github.actor != 'dependabot[bot]' &&
            github.actor != 'github-actions[bot]' &&
            github.actor != 'protected-auto-commits[bot]'
        name: Pre-commit Checks
        runs-on: ubuntu-latest
        concurrency: pre-commit
        steps:
            - name: Harden the runner
              uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
              with:
                  egress-policy: audit

            - name: Checkout Code
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
              with:
                  fetch-depth: 0

            - name: Setup Python
              uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
              with:
                  python-version: "3.13"
                  cache: "pip"

            - name: Run pre-commit
              run: |
                  pip install pre-commit
                  pre-commit run --all-files --show-diff-on-failure

    code-coverage:
        name: Codecov
        runs-on: ubuntu-latest
        needs: pre-commit
        permissions:
            contents: read
            pull-requests: write
        steps:
            - name: Harden the runner
              uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
              with:
                  egress-policy: audit

            - name: Checkout Code
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
              with:
                  fetch-depth: 0

            - name: Setup Python
              uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
              with:
                  python-version: "3.13"
                  cache: "pip"

            - name: Install Dependencies
              run: pip install -r requirements.txt

            - name: Run tests with coverage
              run: |
                  pytest --cov=api --cov-report=xml --cov-report=term-missing
              env:
                  INPUT_WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
                  GITHUB_REPOSITORY: ${{ github.repository }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload test results to Codecov
              if: ${{ !cancelled() }}
              uses: codecov/test-results-action@47f89e9acb64b76debcd5ea40642d25a4adced9f # v1.1.1
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./coverage.xml
                  flags: unittests
                  name: codecov-umbrella

            - name: SonarQube Scan
              uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602 # v6.0.0
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
